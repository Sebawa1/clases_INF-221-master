#!/bin/bash

# CLASS-VERSION-GEN
#
# Copyright (c) 2013-2014, 2016 Horst H. von Brand
# Bajo licencia MIT. Vea LICENSE-MIT para detalles


VF=version
CVT=class-version.tex
CVF=CLASS-VERSION-FILE

DEF_VER=0.1
DEF_DATE=$(git show -s --format=format:"%ai" v$DEF_VER^{commit} |
	     cut -d ' ' -f 1)

DEF_BRANCH=""

if test -f version
then
	VN=$(cat version) || VN="$DEF_VER"
	VD=$(stat --printf="%y" version | cut -d ' ' -f 1)
elif git rev-parse &> /dev/null
then
	VN=$(git describe --match "v[0-9]*" --dirty 2> /dev/null)
	VD=$(git show -s --format=format:"%ai" | cut -d ' ' -f 1)
	VB=$(git rev-parse --abbrev-ref HEAD)
	test "x$VB" == "xmaster" || VN="$VN ($VB)"
else
	VN="$DEF_VER"
	VD="$DEF_DATE"
fi

VN=$(expr "$VN" : v*'\(.*\)')

if test -r $CVF
then
	VC=$(sed -e 's/^CLASS_VERSION = //' $CVF)
else
	VC=unset
fi

test "$VN" = "$VC" || {
	echo >&2 "Class version: $VN"
	rm -f $CVF $CVT

	echo "CLASS_VERSION = $VN" > $CVF

	echo "% This file is autogenerated, don't edit" > $CVT
	echo >> $CVT
	echo "\\newcommand{\\classversion}{$VN}" >> $CVT
	echo "\\newcommand{\\classdate}{$VD}" >> $CVT
}
